#!/usr/bin/env python3
"""
Monitor reference library processing status.

Thin automation layer showing background job progress without heavy orchestration.
"""

import json
from pathlib import Path
from datetime import datetime

REFS_DIR = Path(__file__).parent.absolute()
PDF_DIR = REFS_DIR / "pdf"
TXT_DIR = REFS_DIR / "txt"
IMAGES_DIR = REFS_DIR / "images"
METADATA_DIR = REFS_DIR / "metadata"
INDEX_DIR = REFS_DIR / "index"


def check_extraction_progress():
    """Phase 1: Extraction status."""
    total_pdfs = len(list(PDF_DIR.glob("*.pdf")))
    total_txt = len(list(TXT_DIR.glob("*.txt")))
    total_metadata = len([f for f in METADATA_DIR.glob("*.json") if not "_analysis" in f.name])
    total_img_dirs = len([d for d in IMAGES_DIR.iterdir() if d.is_dir()])

    return {
        "phase": "Extraction",
        "total_pdfs": total_pdfs,
        "txt_files": total_txt,
        "metadata_stubs": total_metadata,
        "image_dirs": total_img_dirs,
        "complete": total_txt == total_pdfs
    }


def check_caption_status():
    """Check caption extraction completeness."""
    total_with_captions = 0
    total_images = 0
    high_confidence = 0

    for img_dir in IMAGES_DIR.iterdir():
        if not img_dir.is_dir():
            continue

        meta_file = img_dir / "metadata.json"
        if not meta_file.exists():
            continue

        try:
            meta = json.loads(meta_file.read_text())
            figures = meta.get("figures", [])
            total_images += len(figures)
            total_with_captions += sum(1 for f in figures if f.get("caption"))
            high_confidence += sum(1 for f in figures if f.get("caption_confidence", 0) >= 0.7)
        except:
            pass

    return {
        "total_images": total_images,
        "with_captions": total_with_captions,
        "high_confidence": high_confidence,
        "caption_rate": 100 * total_with_captions / max(total_images, 1)
    }


def check_analysis_progress():
    """Phase 2: LLM analysis status."""
    total_metadata = len([f for f in METADATA_DIR.glob("*.json") if not "_analysis" in f.name])
    analyzed = 0
    pending = []

    for meta_file in METADATA_DIR.glob("*.json"):
        if "_analysis" in meta_file.name:
            continue

        try:
            meta = json.loads(meta_file.read_text())
            if meta.get("summary") != "[TO BE GENERATED BY LLM]":
                analyzed += 1
            else:
                pending.append(meta["ref_id"])
        except:
            pass

    return {
        "phase": "LLM Analysis",
        "total_refs": total_metadata,
        "analyzed": analyzed,
        "pending": len(pending),
        "pending_list": pending[:10],  # Show first 10
        "complete": len(pending) == 0
    }


def check_catalog_status():
    """Check catalog freshness."""
    catalog_path = INDEX_DIR / "catalog.json"
    if not catalog_path.exists():
        return {"exists": False}

    try:
        cat = json.loads(catalog_path.read_text())
        return {
            "exists": True,
            "total_refs": cat.get("total_refs"),
            "total_images": cat.get("total_images"),
            "total_tokens": cat.get("total_tokens_estimate"),
            "generated": cat.get("generated")
        }
    except:
        return {"exists": True, "error": "Failed to parse"}


def main():
    """Display complete library status."""
    print("=" * 80)
    print("SMoC REFERENCE LIBRARY - STATUS MONITOR")
    print(f"Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 80)
    print()

    # Phase 1: Extraction
    extraction = check_extraction_progress()
    status = "✓ COMPLETE" if extraction["complete"] else "⏳ IN PROGRESS"
    print(f"[Phase 1] Extraction: {status}")
    print(f"  PDFs:          {extraction['total_pdfs']}")
    print(f"  TXT files:     {extraction['txt_files']} / {extraction['total_pdfs']}")
    print(f"  Metadata:      {extraction['metadata_stubs']}")
    print(f"  Image folders: {extraction['image_dirs']}")
    print()

    # Captions
    captions = check_caption_status()
    print(f"[Phase 1b] Caption Extraction:")
    print(f"  Total images:       {captions['total_images']:,}")
    print(f"  With captions:      {captions['with_captions']:,} ({captions['caption_rate']:.1f}%)")
    print(f"  High confidence:    {captions['high_confidence']:,}")
    print()

    # Phase 2: Analysis
    analysis = check_analysis_progress()
    status = "✓ COMPLETE" if analysis["complete"] else "⏳ PENDING"
    print(f"[Phase 2] LLM Analysis: {status}")
    print(f"  Total refs:    {analysis['total_refs']}")
    print(f"  Analyzed:      {analysis['analyzed']}")
    print(f"  Pending:       {analysis['pending']}")
    if analysis["pending_list"]:
        print(f"  Next up:       {', '.join(analysis['pending_list'][:5])}")
    print()

    # Catalog
    catalog = check_catalog_status()
    if catalog["exists"]:
        print(f"[Index] Catalog: EXISTS")
        if "total_refs" in catalog:
            print(f"  Refs:    {catalog['total_refs']}")
            print(f"  Images:  {catalog['total_images']:,}")
            print(f"  Tokens:  {catalog['total_tokens']:,}")
    else:
        print(f"[Index] Catalog: MISSING (run process_library.py)")
    print()

    print("=" * 80)
    print("NEXT ACTIONS")
    print("=" * 80)

    if not extraction["complete"]:
        print("1. Wait for extraction to complete")
    elif analysis["pending"] > 0:
        print(f"1. Analyze {min(analysis['pending'], 10)} priority references")
        print("   python3 analyze_ref.py <REF-ID>")
    else:
        print("1. All processing complete!")
        print("2. Validate schemas: python3 validate_metadata.py --all")
        print("3. Integrate with ./pe refs commands")


if __name__ == "__main__":
    main()
