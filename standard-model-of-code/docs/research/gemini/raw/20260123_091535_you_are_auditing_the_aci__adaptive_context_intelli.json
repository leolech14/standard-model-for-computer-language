{
  "_meta": {
    "saved_at": "2026-01-23T09:15:35.242006",
    "source": "gemini",
    "model": "gemini-3-pro-preview",
    "query": "You are auditing the ACI (Adaptive Context Intelligence) module - the 'curriculum compiler' that prepares context for AI queries.\n\nNOW YOU HAVE THE ACTUAL SOURCE CODE. Review it carefully.\n\nAUDIT QUESTIONS:\n1. Is aci_config.yaml actually wired up to the code? Or are values hardcoded?\n2. How well does ACI integrate with its siblings (analyze.py, HSL, Perplexity)?\n3. What specific code changes are needed to make ACI a true orchestrator?\n4. What documentation is missing?\n\nBe SPECIFIC. Cite file:line numbers. Show code snippets that need to change.",
    "query_length": 550,
    "checksum": "sha256:c29a307ad3c3b76f44308a56df320cbeb59327196125ef53ed902ce620ff4101"
  },
  "response": {
    "content": "This is a forensic audit of the **Adaptive Context Intelligence (ACI)** subsystem based on the provided source code.\n\n### Executive Summary\nThe ACI module is currently operating in a **\"Hardcoded Heuristic\"** state rather than a fully configuration-driven state. While `aci_config.yaml` defines a sophisticated control plane, the actual Python logic ignores this file entirely, relying instead on hardcoded dictionaries and constants. Furthermore, the integration with sibling tools (specifically Perplexity) is disconnected, resulting in a \"dead end\" for the user when external research is required.\n\n---\n\n### 1. Configuration Wiring Audit: The \"Ghost Config\"\n**Verdict: CRITICAL FAILURE.** `aci_config.yaml` is not wired to the codebase.\n\nThe configuration file `context-management/config/aci_config.yaml` defines granular controls for thresholds, budgets, and keywords. However, the Python modules ignore this file and use hardcoded constants that duplicate (or drift from) the YAML values.\n\n**Evidence:**\n*   **Token Budgets:**\n    *   **Config:** `aci_config.yaml` [Lines 37-41] defines `guru: 50000`.\n    *   **Code:** `context_optimizer.py` [Lines 24-29] hardcodes `TOKEN_BUDGETS = { \"guru\": 50_000, ... }`.\n    *   **Issue:** Changing the YAML does nothing. The Python file must be edited.\n*   **Intent Keywords:**\n    *   **Config:** `aci_config.yaml` [Lines 47-66] defines keywords for `architecture`, `debug`, etc.\n    *   **Code:** `query_analyzer.py` [Lines 66-99] hardcodes `INTENT_KEYWORDS = { QueryIntent.ARCHITECTURE: [...], ... }`.\n    *   **Issue:** The analyzer does not load the YAML.\n*   **Missing Loader:**\n    *   `analyze.py` loads `analysis_sets.yaml` [Line 132] and `prompts.yaml` [Line 150], but it **never loads** `aci_config.yaml`.\n\n---\n\n### 2. Integration Audit: Sibling Systems\n**Verdict: PARTIAL / DISCONNECTED.** ACI identifies the need for sibling tools but fails to invoke them programmatically.\n\n#### A. Perplexity (External Research)\n**Status: Dead End.**\nWhen ACI selects the `PERPLEXITY` tier, the system simply prints instructions and exits, rather than calling the available tool.\n*   **Evidence:** `analyze.py` [Lines 1178-1183]:\n    ```python\n    if decision.tier == Tier.PERPLEXITY:\n        print(\"[PERPLEXITY] External research tier selected.\", file=sys.stderr)\n        print(\"Use the Perplexity MCP server for this query:\", file=sys.stderr)\n        # ...\n        sys.exit(0) # <--- Execution stops here\n    ```\n*   **Missed Opportunity:** `perplexity_research.py` exists and is importable, but is unused by the main flow.\n\n#### B. HSL (Holographic-Socratic Layer)\n**Status: Unaware.**\n*   **Evidence:** `tier_router.py` logic is purely based on `QueryProfile` (Intent/Complexity/Scope). It does not check `hsl_daemon.py` status or the `semantic_models.yaml` state.\n*   **Consequence:** ACI routes `VALIDATE` queries [Line 85, `tier_router.py`] to `Tier.LONG_CONTEXT` (Gemini), completely bypassing the specialized Socratic Validator logic built into `analyze.py --verify`.\n\n#### C. `analyze.py` (The Host)\n**Status: Superficial.**\n*   ACI is treated as a \"routing suggester\" rather than a controller. `analyze.py` [Lines 1162-1200] contains the logic for handling the decision, rather than ACI returning an executable strategy.\n\n---\n\n### 3. Required Code Changes for True Orchestration\n\nTo make ACI a \"true orchestrator,\" we must bridge the gap between configuration and execution.\n\n#### A. Implement Config Loader\n**File:** `context-management/tools/ai/aci/config_loader.py` (New File)\n**File:** `context-management/tools/ai/aci/__init__.py`\n\nWe need a singleton to load the YAML and override the hardcoded defaults.\n\n```python\n# PROPOSED CHANGE for __init__.py or config_loader.py\nimport yaml\nfrom pathlib import Path\n\n# Load config once\nCONFIG_PATH = Path(__file__).parent.parent.parent.parent / \"config/aci_config.yaml\"\n_ACI_CONFIG = {}\nif CONFIG_PATH.exists():\n    with open(CONFIG_PATH) as f:\n        _ACI_CONFIG = yaml.safe_load(f)\n\ndef get_config():\n    return _ACI_CONFIG\n```\n\n#### B. Refactor `query_analyzer.py` to use Config\n**Target:** `context-management/tools/ai/aci/query_analyzer.py`\n\n```python\n# CURRENT (Hardcoded) [Lines 66-68]\nINTENT_KEYWORDS = {\n    QueryIntent.ARCHITECTURE: [ ... ]\n}\n\n# REQUIRED CHANGE\nfrom .config_loader import get_config\nconfig = get_config()\n\n# Merge hardcoded defaults with YAML overrides\nINTENT_KEYWORDS = {\n    QueryIntent.ARCHITECTURE: config.get('intent_keywords', {}).get('architecture', []) + [\n        \"how does\", \"architecture\", ... # fallback defaults\n    ],\n    # ...\n}\n```\n\n#### C. Activate Perplexity Integration\n**Target:** `context-management/tools/ai/analyze.py`\n\nThe script needs to import the research tool and execute it when recommended.\n\n```python\n# REQUIRED CHANGE around Line 1178 in analyze.py\nif decision.tier == Tier.PERPLEXITY:\n    try:\n        from perplexity_research import research\n        print(\"[ACI] Auto-executing Perplexity Research...\", file=sys.stderr)\n        result = research(args.prompt, model=\"sonar-reasoning\")\n        print(result['content'])\n        sys.exit(0)\n    except ImportError:\n        print(\"Perplexity tool not found in path.\")\n```\n\n#### D. Wire Feedback Loop\n**Target:** `context-management/tools/ai/analyze.py`\n\nAlthough `log_aci_query` is imported [Line 113], it is never called.\n\n```python\n# REQUIRED CHANGE at end of main execution in analyze.py\nif args.aci:\n    # Calculate stats\n    duration = int((time.time() - start_time) * 1000)\n    log_aci_query(\n        profile=profile, # Need to expose this from analyze_and_route\n        decision=decision,\n        tokens_input=token_usage.prompt,   # hypothetical\n        tokens_output=token_usage.response, # hypothetical\n        success=True,\n        duration_ms=duration\n    )\n```\n\n---\n\n### 4. Missing Documentation\n\n1.  **ACI Tuning Guide:** `AI_USER_GUIDE.md` mentions the tool but does not explain how to modify `aci_config.yaml` to change behavior (e.g., \"How to add a new 'Intent' keyword\").\n2.  **Architecture Diagram:** There is no visual representation of how `analyze.py` hands off control to `aci` and receives a `OptimizedContext`.\n3.  **Feedback Loop Analysis:** There is no documentation on how to read or act upon `.agent/intelligence/aci_feedback.yaml`. A script `aci_stats.py` is likely needed to visualize this data.\n\n### Summary of Recommendations\n\n1.  **Immediate Fix:** Delete the hardcoded dictionaries in `query_analyzer.py` and `context_optimizer.py` and replace them with a YAML loader referencing `aci_config.yaml`.\n2.  **Integration:** Modify `analyze.py` to actually call `perplexity_research.py` instead of printing a suggestion.\n3.  **Refinement:** Route `VALIDATE` intent queries to the HSL/Socratic validator (`--verify`) logic instead of the generic Long Context LLM.",
    "mode": "standard"
  }
}