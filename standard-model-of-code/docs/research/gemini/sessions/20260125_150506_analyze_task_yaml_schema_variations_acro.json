{
  "session_start": "2026-01-25 15:04:28",
  "session_end": "2026-01-25 15:05:06",
  "model": "gemini-3-pro-preview",
  "total_tokens_in": 18177,
  "total_tokens_out": 1920,
  "turn_count": 2,
  "turns": [
    {
      "timestamp": 1769364268.360281,
      "timestamp_str": "2026-01-25 15:04:28",
      "role": "user",
      "content": "Analyze task YAML schema variations across: .agent/schema/task.schema.yaml, .agent/schema/opportunity.schema.yaml, .agent/registry/active/*.yaml, .agent/registry/inbox/*.yaml. What fields are inconsistent? Propose a unified schema."
    },
    {
      "timestamp": 1769364306.718529,
      "timestamp_str": "2026-01-25 15:05:06",
      "role": "assistant",
      "content": "Based on the provided codebase context, I have analyzed the schema variations across the active tasks (`TASK-*.yaml`) and inferred the structure of opportunities and sprints.\n\nHere is the analysis of inconsistencies and a proposal for a Unified Task Schema (v2.0).\n\n### 1. Inconsistency Analysis\n\nThere is significant drift between tasks created at different times (Pipeline Refactor vs. Infrastructure vs. Agent Foundation).\n\n#### A. Temporal Fields (High Variance)\n| Concept | Variation 1 | Variation 2 | Variation 3 | Recommendation |\n| :--- | :--- | :--- | :--- | :--- |\n| **Creation** | `created: '2026-01-23...'` | `created_at: '...'` | `tracking.created_at` | `created_at` (ISO 8601) |\n| **Update** | `updated: '...'` | `updated_at: '...'` | (Missing) | `updated_at` (ISO 8601) |\n| **Completion** | `closed_at` | `completed_at` | `deferred_at` | `completed_at` (generic) |\n\n#### B. Provenance & Linking\n| Concept | Variation 1 | Variation 2 | Recommendation |\n| :--- | :--- | :--- | :--- |\n| **Source** | `promoted_from: OPP-XXX` | `source_opp: OPP-XXX` | `source_id` |\n| **Sprint** | `sprint_id: SPRINT-XXX` | `sprint: SPRINT-XXX` | `sprint_id` |\n| **Dependency** | `blocks` / `blocked_by` | `unblocks` | `dependencies` (list) |\n\n#### C. Categorization\n| Concept | Variation 1 | Variation 2 | Variation 3 | Recommendation |\n| :--- | :--- | :--- | :--- | :--- |\n| **Grouping** | `category: PIPELINE` | `domain: infrastructure` | `tags: [...]` | `domain` + `tags` |\n| **Urgency** | `priority: P0` | `risk: A+` | (Implied by ID) | `priority` (P0-P3) |\n\n#### D. Execution Logic (Critical Divergence)\n*   **Pattern A (Pipeline Tasks):** `steps` is a list of objects (`id`, `action`, `status`, `evidence`).\n*   **Pattern B (Infrastructure):** `execution_plan` is a list of objects (`step`, `action`, `effort`).\n*   **Pattern C (Triage):** `steps` is a list of objects, but `steps_completed` is a separate list of IDs.\n*   **Pattern D (Decision Deck):** `deliverables` object with `completed` and `pending` lists.\n\n---\n\n### 2. Proposed Unified Schema (Version 2.0)\n\nThis schema consolidates the 4D confidence model from `INDEX.md` with the rigorous execution tracking of `TASK-007`.\n\n```yaml\n# .agent/schema/task_v2.schema.yaml\n\n# CORE IDENTITY\nid: \"TASK-{NUMBER}\"         # Required: Format TASK-\\d+\ntitle: String               # Required: Short summary\nstatus: Enum                # Required: [DISCOVERY, READY, ACTIVE, BLOCKED, COMPLETE, DEFERRED, WONT_DO]\nowner: String               # Optional: Agent or User ID (e.g., \"claude-session-20260123\")\n\n# PROVENANCE & TIMING\ncreated_at: ISO8601         # Required\nupdated_at: ISO8601         # Required\ncompleted_at: ISO8601       # Optional (Required if status is COMPLETE/WONT_DO)\nsource_id: String           # Optional: Link to OPP-XXX or previous TASK-XXX\nsprint_id: String           # Optional: Link to SPRINT-XXX\n\n# CLASSIFICATION\ndomain: String              # Required: [pipeline, visualization, infrastructure, intelligence, observer]\npriority: Enum              # Optional: [P0, P1, P2, P3]\ntags: List[String]          # Optional: Flexible grouping\n\n# CONTEXT\ndescription: Markdown       # Required: Detailed description\nclosure_reason: String      # Optional: Required if WONT_DO or DEFERRED\noutput_artifacts:           # Optional: List of produced assets\n  - path: String\n    description: String\n\n# 4D CONFIDENCE (Unified)\n# Formula: Overall = min(Factual, Alignment, Current, Onwards)\nconfidence:\n  factual: Float            # 0-100: Understanding of current state\n  alignment: Float          # 0-100: Mission fit\n  current: Float            # 0-100: Codebase fit\n  onwards: Float            # 0-100: Future roadmap fit\n  overall: Float            # Calculated\n  verdict: String           # [ACCEPT, DEFER, REJECT]\n\n# EXECUTION PLAN\n# Consolidates 'steps', 'execution_plan', and 'deliverables'\nsteps:\n  - id: String              # e.g., \"S01\"\n    action: String          # What to do\n    status: Enum            # [PENDING, IN_PROGRESS, DONE, SKIPPED]\n    evidence:               # Optional: Proof of completion\n      file: String\n      line: Number\n      note: String\n\n# DEPENDENCIES\ndependencies:\n  blocked_by: List[String]  # Task IDs\n  blocks: List[String]      # Task IDs\n```\n\n---\n\n### 3. Migration Strategy (Field Mapping)\n\nTo normalize the repository, apply the following transformations:\n\n1.  **Normalize Dates:**\n    *   `created` \u2192 `created_at`\n    *   `updated` \u2192 `updated_at`\n    *   `closed_at` / `deferred_at` \u2192 `completed_at` (status determines semantic meaning).\n\n2.  **Normalize Execution:**\n    *   Move `execution_plan` items \u2192 `steps`.\n    *   Move `deliverables.pending` \u2192 `steps` (status: PENDING).\n    *   Move `deliverables.completed` \u2192 `steps` (status: DONE).\n\n3.  **Normalize Classification:**\n    *   `category` \u2192 `domain` (lowercase).\n    *   `risk` \u2192 Convert to `priority` (A++ = P0, A = P1, etc.) or move to `tags`.\n\n4.  **Normalize Confidence:**\n    *   Ensure all tasks have the `confidence` object. Older tasks might just have a scalar value; these need to be expanded to the 4D structure (defaulting sub-scores to the scalar value).\n\n### 4. Implementation Plan\n\n**Step 1: Create Schema Validator**\nCreate `.agent/tools/validate_schema.py` using `pydantic` or `jsonschema` to enforce the v2 structure.\n\n**Step 2: Batch Migration Script**\nWrite a script to load all `TASK-*.yaml` files, apply the mapping logic above, and rewrite them.\n\n**Step 3: Update Tooling**\nUpdate `promote_opportunity.py` and `task_store.py` to generate/read the new format.\n\n**Example Migrated YAML (TASK-059):**\n\n```yaml\nid: TASK-059\ntitle: Sprawl Consolidation Infrastructure\nstatus: COMPLETE\ncreated_at: '2026-01-23T17:28:08.260984'\nupdated_at: '2026-01-23T18:00:00.000000' # Inferred\ncompleted_at: '2026-01-23T18:00:00.000000' # Inferred\nsource_id: OPP-059\ndomain: infrastructure\npriority: P2\ndescription: |\n  Infrastructure improvements for managing repository sprawl...\nconfidence:\n  factual: 100\n  alignment: 95\n  current: 100\n  onwards: 90\n  overall: 90\nsteps:\n  - id: S01\n    action: Created SPRAWL_CONSOLIDATION_PLAN.md\n    status: DONE\n  - id: S02\n    action: Updated archive config with 4 large directories\n    status: DONE\n  # ... (remaining items from description)\n```"
    }
  ]
}